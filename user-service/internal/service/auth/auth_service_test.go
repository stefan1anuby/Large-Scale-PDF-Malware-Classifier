package auth_test

import (
	"strings"
	"testing"
	"time"
	"user-service/internal/domain/users"
	"user-service/internal/service/auth"

	"github.com/dgrijalva/jwt-go"
	"github.com/google/uuid"
	"github.com/stretchr/testify/assert"
)

func setupAuthServiceWithUser() (*auth.AuthService, *users.User, error) {
	authService, err := auth.NewAuthService(auth.WithMemoryUserRepository())
	if err != nil {
		return nil, nil, err
	}

	username := "testuser"
	email := "test@test.com"
	password := "test123"
    credit := 1
	newUser, err := authService.Register(username, email, password, credit)
	if err != nil {
		return nil, nil, err
	}

	return authService, newUser, nil
}

func TestLogin(t *testing.T) {
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    // Test valid login
    token, err := authService.Login(user.Username, "test123")
    assert.NoError(t, err)
    assert.NotEmpty(t, token)

    // Test invalid login
    _, err = authService.Login(user.Username, "wrongpassword")
    assert.Error(t, err)
}

func TestChangePassword(t *testing.T) {
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    _, err = authService.ChangePassword(user.ID, "newpass123")
    assert.NoError(t, err)
}

func TestValidateToken(t *testing.T) {
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    // Create and validate a token
    expirationTime := time.Now().Add(30 * time.Minute)
    claims := &auth.Claims{
        UserID: user.ID.String(),
        StandardClaims: jwt.StandardClaims{
            ExpiresAt: expirationTime.Unix(),
        },
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    tokenString, _ := token.SignedString(auth.JwtKey)

    validatedUser, err := authService.ValidateToken(tokenString)
    assert.NoError(t, err)
    assert.NotNil(t, validatedUser)
    assert.Equal(t, user.ID, validatedUser.ID)
}

func TestValidateTokenWithAlteredPayload(t *testing.T) {
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    // Create a valid token first
    validToken, err := authService.Login(user.Username, "test123")
    assert.NoError(t, err)

    // Alter the token (e.g., change a character in the payload)
    parts := strings.Split(validToken, ".")
    if len(parts) == 3 {
        parts[1] = "tamperedPayload"
        invalidToken := strings.Join(parts, ".")

        _, err := authService.ValidateToken(invalidToken)
        assert.Error(t, err, "Should error on tampered token")
    } else {
        t.Error("Invalid token format")
    }
}

func TestValidateTokenWithInvalidSignature(t *testing.T) {
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    // Create a valid token first
    validToken, err := authService.Login(user.Username, "test123")
    assert.NoError(t, err)

    // Invalidate the signature
    parts := strings.Split(validToken, ".")
    if len(parts) == 3 {
        parts[2] = "invalidSignature"
        invalidToken := strings.Join(parts, ".")

        _, err := authService.ValidateToken(invalidToken)
        assert.Error(t, err, "Should error on token with invalid signature")
    } else {
        t.Error("Invalid token format")
    }
}

func TestValidateExpiredToken(t *testing.T) {
    authService, _, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    // Create an expired token
    expiredClaims := &auth.Claims{
        UserID: uuid.New().String(),
        StandardClaims: jwt.StandardClaims{
            ExpiresAt: time.Now().Add(-time.Hour).Unix(), // 1 hour in the past
        },
    }
    expiredToken := jwt.NewWithClaims(jwt.SigningMethodHS256, expiredClaims)
    tokenString, _ := expiredToken.SignedString(auth.JwtKey)

    _, err = authService.ValidateToken(tokenString)
    assert.Error(t, err, "Should error on expired token")
}

func TestConsumeUserCredit(t *testing.T){
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    ok,err := authService.ConsumeUserCredit(user.ID)
    assert.NoError(t,err,"Should not have error")
    assert.True(t, ok)

    ok,err = authService.ConsumeUserCredit(user.ID)
    assert.NoError(t,err,"Should not have error")
    assert.False(t, ok)
}

func TestGetUserCredit(t *testing.T){
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    amount,err := authService.GetUserCredit(user.ID)
    assert.NoError(t,err,"Should not have error")
    assert.Equal(t, amount, 1)
}

func TestAddUserCredit(t *testing.T){
    authService, user, err := setupAuthServiceWithUser()
    assert.NoError(t, err)

    amount_to_add := 99
    ok,err := authService.AddUserCredit(user.ID , amount_to_add)
    assert.NoError(t,err,"Should not have error")
    assert.True(t, ok)
}

